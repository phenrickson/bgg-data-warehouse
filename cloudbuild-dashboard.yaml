# Cloud Build configuration for BGG Dashboard
steps:
  # Build the dashboard image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-f', 'Dockerfile.dashboard', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/bgg-data-warehouse/dashboard:${_ENVIRONMENT}', '.']

  # Push the dashboard image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/bgg-data-warehouse/dashboard:${_ENVIRONMENT}']

  # Deploy Dashboard to Cloud Run (create or update)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Try to update first, if it fails (service doesn't exist), create it
        gcloud run deploy bgg-dashboard-${_ENVIRONMENT} \
          --image=us-central1-docker.pkg.dev/$PROJECT_ID/bgg-data-warehouse/dashboard:${_ENVIRONMENT} \
          --platform=managed \
          --region=us-central1 \
          --allow-unauthenticated \
          --memory=1Gi \
          --cpu=1 \
          --service-account=bgg-data-warehouse@$PROJECT_ID.iam.gserviceaccount.com \
          --set-env-vars=ENVIRONMENT=${_ENVIRONMENT},GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account-key.json,STREAMLIT_SERVER_PORT=8501 \
          --port=8501 \
          --timeout=300s \
          --min-instances=0 \
          --max-instances=1 \
          --command=/bin/bash \
          --args=/app/start.sh

# Images to push to Artifact Registry
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/bgg-data-warehouse/dashboard:${_ENVIRONMENT}'

# Timeout for the entire build
timeout: '1200s'  # 20 minutes
