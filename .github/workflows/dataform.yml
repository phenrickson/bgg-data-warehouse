name: Run Dataform

on:
  # Run after pipeline completes
  workflow_run:
    workflows: ["Run BGG Data Warehouse Jobs"]
    types: [completed]

  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run in'
        required: true
        default: 'prod'
        type: choice
        options:
        - prod
        - dev
        - test

jobs:
  dataform:
    name: Run Dataform Transformations
    runs-on: ubuntu-latest
    # Only run if triggered manually OR if the pipeline succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Google Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_BGG_DW }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      - name: Run Dataform
        run: |
          ENVIRONMENT=${{ steps.env.outputs.environment }}
          echo "Running Dataform transformations for $ENVIRONMENT..."

          # Create a workflow invocation using the REST API
          ACCESS_TOKEN=$(gcloud auth print-access-token)

          curl -X POST \
            "https://dataform.googleapis.com/v1beta1/projects/bgg-data-warehouse/locations/us/repositories/bgg-data-warehouse/workflowInvocations" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}'
