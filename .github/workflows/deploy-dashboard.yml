name: Deploy Dashboard

on:
  push:
    branches: [ main ]
    paths:
      - 'src/visualization/**'
      - 'docker/Dockerfile.dashboard'
      - '.github/workflows/deploy-dashboard.yml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: bgg-data-warehouse
  GCP_REGION: us-central1

jobs:
  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_BGG_DW }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build and push Docker image
        run: |
          docker build -f docker/Dockerfile.dashboard -t gcr.io/${GCP_PROJECT_ID}/bgg-dashboard:latest .
          docker push gcr.io/${GCP_PROJECT_ID}/bgg-dashboard:latest

      - name: Deploy Dashboard to Cloud Run
        run: |
          gcloud run deploy bgg-dashboard \
            --project=${GCP_PROJECT_ID} \
            --image=gcr.io/${GCP_PROJECT_ID}/bgg-dashboard:latest \
            --platform=managed \
            --region=${GCP_REGION} \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --service-account=bgg-data-warehouse@${GCP_PROJECT_ID}.iam.gserviceaccount.com \
            --set-env-vars="STREAMLIT_SERVER_PORT=8501" \
            --port=8501 \
            --timeout=300s \
            --min-instances=0 \
            --max-instances=1

      - name: Output Dashboard URL
        run: |
          echo "Dashboard deployed to: $(gcloud run services describe bgg-dashboard --project=${GCP_PROJECT_ID} --region=${GCP_REGION} --format='value(status.url)')"
